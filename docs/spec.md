# 通信规范
这是一个分布式DDNS的项目，自动同步IP地址
目前还没有实现，以后再实现

## 术语表
同一设备：由用户指定的一些通信地址的集合
签名：数字签名，用于确认地址的真实性
密钥对：用于签名和验证的公钥和私钥

通信地址：域名，IPv4, IPv6, MAC等能有助于两个设备间建立通信的信息
目标设备：待获取通信地址的设备
其他设备：除本机和目标设备以外的设备

## 通信地址大类
|  类型    |  举例         |         说明        |
|:-------:|:--------------|:-------------------|
|  底层    |MAC            |                    |
|  TCP/IP |IPv4, IPv6     |较容易获取，可能经常改变 |
|  互联网  |域名            |较难获取，不容易改变    |
| 供人类使用|电子邮箱,QQ,手机号|一般需要有人介入       |
| 地理位置 |行政地址,经纬度    |                   |

## 协议包的封装
有二进制和文本两种形式  
通用包头：
| 名称 | 偏移|  描述  |
|:----:|----:|:-------|
| 魔数 |    0| 0xB2AD |
| 版本 |    2| 版本号 |
|命令块| 不定| 见后表 |

命令块：
| 缩写 |长度| 编号 |       参数      | 描述            |
|:----:|---:|-----:|:----------------|:----------------|
|  GN  |   1| 0x00 |                 |获取名称         |
|  PN  | >75| 0x01 |Ver,Len,Name,Sign|                 |
|  GA  |   1| 0x02 |                 |获取通信地址     |
|  PA  | 121| 0x03 |Ver,IPv6,Sign    |                 |
|  GK  |   1| 0x04 |                 |获取签名公钥     |
|  PK  |  33| 0x05 |Pub              |                 |
|  GI  |   1| 0x06 |                 |获取描述信息     |
|  PI  | >75| 0x07 |Ver,Len,Info,Sign|                 |
|  GL  |    | 0x08 |                 |获取其他设备列表 |
|  PL  |    | 0x09 |                 |                 |
|  NF  |   1| 0x0B |                 |找不到相应信息   |
|  GV  |   1| 0x0C |                 |获取最新版本     |
|  PV  |   9| 0x0D |Ver              |                 |
| InVg |   9| 0x0E |Ver              |(If new Ver get)请求新版本数据|
| STAT |    | 0x0F |                 |获取运行状态     |
InVg后至下一次TG前的Gx命令：如果接收端版本大于GV命令中的版本则响应这些命令，否则不响应

信息块：
| 缩写 |长度| 编号 |  参数  | 描述                       |
|:----:|---:|-----:|:-------|:---------------------------|
| TIME |    | 0x80 |        |发送时间                    |
| HASH |    | 0x81 |        |直到最近非HASH命令块的哈希值|
| SIGN |    | 0x82 |        |直到最近的非SIGN命令块的签名|


## 规则
签名算法使用Ed25519
|缩写| 名称 |长度|
|:--:|:----:|---:|
|Sign| 签名 |  64|
|Ver |版本号|   8|
|Len | 长度 |   2|

## 定期测试
```
Vxy:  x上y机信息的版本
Vxyx: x知道y机上的x版本
A       B  | A端更新 |              A->B更新         |      B->A更新    | B端更新 |
 ------>   |         |TG(PubKa){if Vaba<Vaa}, PV(Vaa)|InVg(Vab),GA()    |         |
 <------   |Sab      |GA(){if Vba<Vaa}               |PA(Sb){if Vbb>Vab}|         |
 ------>   |         |PA(Sa)                         |已接收签名        |Sba,Vbab |
 <------   |Vaba     |已接收签名                     |                  |         |
```
